name: CI

on:
  push:
    branches:
      - main
  pull_request:

permissions:
  contents: read

jobs:
  core:
    name: Core (host build + tests)
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Configure core host build
        run: cmake -S packages/lightpath -B packages/lightpath/build -DLIGHTPATH_CORE_BUILD_TESTS=ON

      - name: Build core host target
        run: cmake --build packages/lightpath/build --parallel

      - name: Run core tests
        run: ctest --test-dir packages/lightpath/build --output-on-failure

  core-asan:
    name: Core (ASan)
    runs-on: ubuntu-latest
    env:
      ASAN_OPTIONS: detect_leaks=0
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Configure ASan build
        run: CC=clang CXX=clang++ cmake -S packages/lightpath -B packages/lightpath/build-asan -DLIGHTPATH_CORE_BUILD_TESTS=ON -DLIGHTPATH_CORE_ENABLE_ASAN=ON

      - name: Build ASan target
        run: cmake --build packages/lightpath/build-asan --parallel

      - name: Run ASan tests
        run: ctest --test-dir packages/lightpath/build-asan --output-on-failure

  core-ubsan:
    name: Core (UBSan)
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Configure UBSan build
        run: CC=clang CXX=clang++ cmake -S packages/lightpath -B packages/lightpath/build-ubsan -DLIGHTPATH_CORE_BUILD_TESTS=ON -DLIGHTPATH_CORE_ENABLE_UBSAN=ON

      - name: Build UBSan target
        run: cmake --build packages/lightpath/build-ubsan --parallel

      - name: Run UBSan tests
        run: ctest --test-dir packages/lightpath/build-ubsan --output-on-failure

  core-warnings:
    name: Core (Warnings)
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Configure strict warning build
        run: CC=clang CXX=clang++ cmake -S packages/lightpath -B packages/lightpath/build-warnings -DLIGHTPATH_CORE_BUILD_TESTS=ON -DLIGHTPATH_CORE_ENABLE_STRICT_WARNINGS=ON

      - name: Build strict warning target
        run: cmake --build packages/lightpath/build-warnings --parallel

      - name: Run strict warning tests
        run: ctest --test-dir packages/lightpath/build-warnings --output-on-failure

  core-benchmark:
    name: Core (Benchmark guardrail)
    runs-on: ubuntu-latest
    env:
      LIGHTPATH_MIN_BENCHMARK_FPS: "1000"
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Configure benchmark build
        run: cmake -S packages/lightpath -B packages/lightpath/build-benchmark -DLIGHTPATH_CORE_BUILD_BENCHMARKS=ON -DLIGHTPATH_CORE_BUILD_TESTS=OFF -DCMAKE_BUILD_TYPE=Release

      - name: Build benchmark target
        run: cmake --build packages/lightpath/build-benchmark --target lightpath_core_benchmark --parallel

      - name: Enforce benchmark budget
        run: packages/lightpath/scripts/check-benchmark.sh packages/lightpath/build-benchmark/lightpath_core_benchmark

  core-packaging:
    name: Core (Packaging smoke)
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Validate packaging metadata
        run: |
          python -m py_compile packages/lightpath/conanfile.py
          python - <<'PY'
          import json
          from pathlib import Path
          with Path("packages/lightpath/packaging/vcpkg/vcpkg.json").open("r", encoding="utf-8") as fh:
              json.load(fh)
          print("vcpkg.json is valid JSON")
          PY

      - name: Configure package smoke build
        run: cmake -S packages/lightpath -B packages/lightpath/build-packaging -DLIGHTPATH_CORE_BUILD_TESTS=OFF -DCMAKE_BUILD_TYPE=Release

      - name: Build package smoke prerequisites
        run: cmake --build packages/lightpath/build-packaging --parallel

      - name: Run install + consumer smoke
        run: |
          cmake \
            -Dcmake_command=cmake \
            -Dmain_build_dir=packages/lightpath/build-packaging \
            -Dsource_dir=packages/lightpath/tests/package_smoke \
            -Dbinary_dir=packages/lightpath/build-packaging/tests/package_smoke/build \
            -Dinstall_dir=packages/lightpath/build-packaging/tests/package_smoke/install \
            -P packages/lightpath/tests/package_smoke/run.cmake

  web:
    name: Web (React)
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: apps/control-panel
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm
          cache-dependency-path: apps/control-panel/package-lock.json

      - name: Install dependencies
        run: npm ci --legacy-peer-deps

      - name: Lint
        run: npm run lint

      - name: Build
        run: npm run build

  firmware:
    name: Firmware (PlatformIO smoke)
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: firmware/esp
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install PlatformIO
        run: pip install platformio

      - name: Validate shared core wiring
        run: |
          test -L src
          test "$(readlink src)" = "../../packages/lightpath/src"

      - name: Generate esp32dev compilation database
        run: pio run -e esp32dev -t compiledb

  simulator:
    name: Simulator (Scoped smoke)
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: apps/simulator
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Validate simulator project layout
        run: |
          test -f Makefile
          test -f config.make
          grep -q '^OF_ROOT ?= ../../../../openframeworks$' config.make
          if grep -Eq '^OF_ROOT ?= /' config.make; then
            echo "config.make must not hardcode absolute OF_ROOT paths"
            exit 1
          fi

      - name: Optional make dry-run with OF_ROOT
        run: |
          if [ -n "${OF_ROOT:-}" ] && [ -d "${OF_ROOT}" ]; then
            make -n OF_ROOT="${OF_ROOT}"
          else
            echo "No openFrameworks checkout configured in CI; scoped simulator checks only."
          fi
