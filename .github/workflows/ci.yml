name: CI

on:
  push:
    branches:
      - main
  pull_request:

permissions:
  contents: read

jobs:
  core:
    name: Core (host build + tests)
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Configure core host build
        run: cmake -S packages/core -B packages/core/build -DLIGHTGRAPH_CORE_BUILD_TESTS=ON

      - name: Build core host target
        run: cmake --build packages/core/build --parallel

      - name: Run core smoke tests
        run: ctest --test-dir packages/core/build --output-on-failure

  core-asan:
    name: Core (ASan)
    runs-on: ubuntu-latest
    env:
      ASAN_OPTIONS: detect_leaks=0
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Configure ASan build
        run: CC=clang CXX=clang++ cmake -S packages/core -B packages/core/build-asan -DLIGHTGRAPH_CORE_BUILD_TESTS=ON -DLIGHTGRAPH_CORE_ENABLE_ASAN=ON

      - name: Build ASan target
        run: cmake --build packages/core/build-asan --parallel

      - name: Run ASan tests
        run: ctest --test-dir packages/core/build-asan --output-on-failure

  web:
    name: Web (React)
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: apps/control-panel
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm
          cache-dependency-path: apps/control-panel/package-lock.json

      - name: Install dependencies
        run: npm ci --legacy-peer-deps

      - name: Lint
        run: npm run lint

      - name: Build
        run: npm run build

  firmware:
    name: Firmware (PlatformIO smoke)
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: firmware/esp
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install PlatformIO
        run: pip install platformio

      - name: Validate shared core wiring
        run: |
          test -L src
          test "$(readlink src)" = "../../packages/core/src"

      - name: Generate esp32dev compilation database
        run: pio run -e esp32dev -t compiledb

  simulator:
    name: Simulator (Scoped smoke)
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: packages/simulator
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Validate simulator project layout
        run: |
          test -f Makefile
          test -f config.make
          grep -q '^OF_ROOT ?= ../../../../openframeworks$' config.make
          if grep -Eq '^OF_ROOT ?= /' config.make; then
            echo "config.make must not hardcode absolute OF_ROOT paths"
            exit 1
          fi

      - name: Optional make dry-run with OF_ROOT
        run: |
          if [ -n "${OF_ROOT:-}" ] && [ -d "${OF_ROOT}" ]; then
            make -n OF_ROOT="${OF_ROOT}"
          else
            echo "No openFrameworks checkout configured in CI; scoped simulator checks only."
          fi
